<%- include('../partials/sidebar'); %>
    <%- include('../partials/header'); %>
    <link href="https://cdn.datatables.net/v/bs5/jszip-3.10.1/dt-2.0.8/b-3.0.2/b-html5-3.0.2/sb-1.7.1/sp-2.3.1/rr-1.5.0/datatables.min.css" rel="stylesheet">
    <script src="https://cdn.datatables.net/v/bs5/dt-2.1.8/b-3.2.0/b-colvis-3.2.0/sb-1.7.1/sp-2.3.1/rr-1.5.0/datatables.min.js"></script>

    <style>
        .btn-close {
            font-size: 24px; 
            padding: 10px 20px; 
        }
    </style>
    <div class="row m-5 mx-3">

        <div class="col-md-9"></div>
        <div class="col-md-3 d-flex justify-content-end">

            <div  class="form-group">
                <div class="input-group input-group-alternative ">
                  <button class="btn btn-xs bg_color px-3 text-white" 
                    data-bs-toggle="modal" data-bs-target="#dialog"  data-original-title="ADD"
                    hx-get="/api/users/create" 
                    hx-target="#dialog-body"
                    hx-swap="innerHTML"
                    hx-indicator="#loading-spinner"
                  >
                      <i class="fa fa-plus me-2"></i>
                      ADD USER
                  </button>
                </div>
            </div>
        </div>
        <br><br>
        <% if (success && success.length > 0) { %>
            <div class="col-12" id="success-toast">
                <div class="alert bg-success text-white font-weight-bold alert-dismissible fade show">
                    <%= success %>
                </div>
            </div>
        <% } %>

        <div class="col-12" id="danger-toast" style="display: none;">
            <div class="alert bg-danger text-white font-weight-bold alert-dismissible fade show error_message">
               
            </div>
        </div>
        <div class="row d-flex justify-content-center">

            <div class="col-12 card">
                <div class="table-responsive p-4">
                    <table class="Table table align-items-center mb-0" id="users-table">
                        <thead>
                            <tr>
                                <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 align-middle text-center">
                                    Username
                                </th>
                                <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 align-middle text-center">
                                    Phone
                                </th>
                                <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 align-middle text-center">
                                    Role
                                </th>

                                <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder align-middle text-center opacity-7">
                                    Operation
                                </th>
                            </tr>
                        </thead>
                        <tbody id="program-table-body" hx-target="closest tr" hx-swap="outerHTML">
                           
                            <% users.map(user => { %>
                                <tr class="py-2">
                                   
                                    <td class="align-middle text-center text-sm">
                                        <h5 class="mb-0 text-sm text-uppercase">
                                            <%= user.username %>
                                        </h5>
                                    </td>
                                    <td class="align-middle text-center text-sm">
                                        <h5 class="mb-0 text-sm text-uppercase">
                                            <%= user.phone %>
                                        </h5>
                                    </td>
                                    <td class="align-middle text-center text-sm">
                                        <h5 class="mb-0 text-sm text-secondary">
                                            <% if(user.role === 'admin') { %>
                                                <span class="badge text-bg-primary">
                                                    admin
                                                </span>
                                            <% } else if(user.role === 'agent') { %>
                                                <span class="badge text-bg-info">
                                                    data entry agent
                                                </span>
                                            <% } else if(user.role === 'supply_chain') { %>
                                                <span class="badge text-bg-warning">
                                                   supply chain
                                                </span>
                                            <% } %>
                                        </h5>
                                    </td>
                                    <td class="align-end  text-end text-end">
                                        <div class="row flex-nowrap">
                                            <div class="col align-middle opacity-8">
                                                <a  href="javascript:;"  data-bs-toggle="modal" 
                                                    data-bs-target="#dialog"  data-original-title="Edit"
                                                    class="text_main_color font-weight-bold text-sm" 
                                                    hx-get="/api/users/edit"
                                                    hx-vals="js:{'id':'<%=user.id%>'}"
                                                    hx-target="#dialog-body"
                                                    hx-swap="innerHTML"
                                                    hx-indicator="#loading-spinner">
                                                    <i class="fas fa-pencil-alt "></i>
                                                    <!-- Edit -->
                                                </a>
                                              </div>
                                              
                                              <div class=" col align-middle opacity-8">
                                                <a  href="javascript:;" class="text-red font-weight-bold text-sm"
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#dialog"  data-original-title="Edit"
                                                    hx-get="/api/users/delete" 
                                                    hx-vals="js:{'id':'<%= user.id %>'}"
                                                    hx-target="#dialog-body"
                                                    hx-swap="innerHTML"
                                                    hx-indicator="#loading-spinner">
                                                    <i class="fas fa-trash text-danger"></i>
                                                    <!-- Delete -->
                                                </a>
                                              </div>
                                        </div>
                                    </td>
                                </tr>
                            <% }) %>
                            
                        </tbody>
                    </table>
                </div>
            </div>
        </div> 
    </div>



    <!-- Modal -->
    <div class="modal fade" data-bs-backdrop="static" id="dialog" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
            <div class="modal-content">
                
                <div class="modal-header d-flex align-items-center flex-column  border-0 ">
                    <button type="button" class="btn-close text-black text-xxl" data-bs-dismiss="modal" aria-label="Close">&times;</button>
                    <img src="https://img.icons8.com/pulsar-line/100/user.png" alt="user"/>
                    <h4 class="nav-link-text font-weight-bold modal-title text-black text-uppercase " id="modal-title"></h4>
                    
                </div>

                <div id="error_message" class="alert bg-danger mx-3 font-weight-bold text-white alert-dismissible fade show error_message" role="alert" style="display: none;">
                    
                </div>

                <!-- Loading spinner -->
                <div id="loading-spinner" class="loading-spinner text-center py-3" style="display: none;">
                    <div class="spinner-border text-dark" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    <p>Loading...</p>
                </div>
               
                <div class="modal-body" id="dialog-body">
                 </div>
                 
            </div>
            
        </div>
    </div>

    <%- include('../toasts/success-toast'); %>
    <%- include('../partials/footer'); %>
    <%- include('../partials/columnFilter'); %>

    <script>
        $(document).ready(function() {
            initializeDataTable('users-table');
            setTimeout(()=>{
                
                $('#success-toast').addClass("d-none");

            }, 3000)
        });
    </script>
    <script>
        $(document).on('click', '.btn-close', function () {
                $(".modal-title").text("");
        });
        htmx.on('htmx:beforeRequest',  (e) => {
            const url = e.detail.elt.getAttribute('hx-get');  
            if(url.includes("/create") || url.includes("/delete") || url.includes("/edit")){
                document.querySelector('.loading-spinner').style.display = 'block'; 
                document.getElementById('error_message').style.display = 'none';    
                document.getElementById('dialog-body').innerHTML = '';              
            }
        });

        // Event listener for when the request completes (hide the spinner)
        htmx.on('htmx:afterRequest', function (e) {
            const url = e.detail.elt.getAttribute('hx-get');  

            if(url.includes("/create") || url.includes("/delete") || url.includes("/edit"))
                document.querySelector('.loading-spinner').style.display = 'none'; 
        
        });

        // Event listener for handling request errors
        htmx.on('htmx:responseError', function (e) {
            const url = e.detail.elt.getAttribute('hx-get');  

            if(url.includes("/create") || url.includes("/delete") || url.includes("/edit")){
                document.querySelector('.loading-spinner').style.display = 'none';
                document.getElementById('error_message').style.display = 'block';
            }
        });
    </script>