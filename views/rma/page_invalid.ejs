<%- include('../partials/sidebar'); %>
    <%- include('../partials/header'); %>
    <link href="https://cdn.datatables.net/v/bs5/jszip-3.10.1/dt-2.0.8/b-3.0.2/b-html5-3.0.2/sb-1.7.1/b-colvis-3.2.0/sp-2.3.1/rr-1.5.0/datatables.min.css" rel="stylesheet">
    <script src="https://cdn.datatables.net/v/bs5/dt-2.0.8/b-3.2.0/b-colvis-3.2.0/sb-1.7.1/sp-2.3.1/jszip-2.5.0/b-html5-3.2.0/rr-1.5.0/datatables.min.js"></script>
  
    <style>
        .btn-close {
            font-size: 24px; 
            padding: 10px 20px; 
        }
        .custom-border-start {
            border-left-width: 5px !important;
        }

    </style>
    <div class="row m-5 mx-3">

        <br><br>
        <% if (success && success.length > 0) { %>
            <div class="col-12" id="success-toast">
                <div class="alert bg-success text-white font-weight-bold alert-dismissible fade show">
                    <%= success %>
                </div>
            </div>
        <% } %>

        <div class="col-12" id="danger-toast" style="display: none;">
            <div class="alert bg-danger text-white font-weight-bold alert-dismissible fade show error_message">
               
            </div>
        </div>
        <div class="col-md-9 px-5">
            <div class="row align-items-center">
                <div class="col-12 col-md-4 mb-3">
                    <label for="date_debut">De:</label>
                    <div class="input-group">
                        <input type="date" name="date_debut" id="date_debut" class="form-control" placeholder="date debut" value="<%= new Date().toISOString().split('T')[0] %>">
                    </div>
                </div>
                <div class="col-12 col-md-4 mb-3">
                    <label for="date_fin">A:</label>
                    <div class="input-group">
                        <input type="date" name="date_fin" id="date_fin" class="form-control" placeholder="date fin" value="<%= new Date().toISOString().split('T')[0] %>">
                    </div>
                </div>
                <div class="col-12 col-md-4 d-flex justify-content-md-start justify-content-end mb-0 mt-3">
                    <button id="exportBtn" class="btn btn-xs bg_color px-3 text-white mb-0" >
                        Export
                    </button>
                </div>
            </div>
        </div>

        <div class="col-md-3 d-flex justify-content-end align-items-start">
            <% if(user.role === "admin" || user.role === "agent") { %>
                <button class="btn btn-xs bg_color px-3 text-white" 
                    data-bs-toggle="modal" data-bs-target="#dialog" data-original-title="ADD"
                    hx-get="/api/rma/create" 
                    hx-target="#dialog-body"
                    hx-swap="innerHTML"
                    hx-indicator=".loading-spinner"
                >
                    <i class="fa fa-plus"></i>
                    ADD REQUEST
                </button>
            <% } %>
        </div>


        <hr>
        
        <!-- No valide RMA REQUESTs -->
        <% if(user.role === "admin" || user.role === "agent") { %>
            <div class="row mt-3">
                <div class="align-self-center"> 
                    <h5 style="color: #b60707;"><img class="mx-3" src="https://img.icons8.com/ios-glyphs/30/b60707/multiply.png" alt="multiply"/>
                        List of Invalid RMA Requests
                    </h5>
                </div>       
                    
                <style>
                    body{
                        overflow-x: hidden;
                    }
                </style>
                <div class="row d-flex justify-content-center">
        
                    <div class="col-12 card">
                        <div class="table-responsive table-responsive-md p-4">
                            <table class="Table table align-items-center mb-0" id="no-valid-rma-table">
                                <thead>
                                    <tr>
                                        <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 align-middle">
                                            State
                                        </th>
                                        <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 align-middle text-center">
                                            Customer Country
                                        </th>
                                        <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 align-middle text-center">
                                            Customer
                                        </th>
                                        <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 align-middle text-center">
                                            Date
                                        </th>
                                        <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 align-middle text-center">
                                            PROCESS
                                        </th>
                                        <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 align-middle text-center">
                                            O/C Brand
                                        </th>
                                        <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 align-middle text-center">
                                            C/SKD Supplier
                                        </th>
                                        <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 align-middle text-center">
                                            Product
                                        </th>
                                        <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 align-middle text-center">
                                            SIZE
                                        </th>
                                        <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 align-middle text-center">
                                            ODF/w/O
                                        </th>
                                        <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 align-middle text-center">
                                            OC Reference
                                        </th>
                                        <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 align-middle text-center">
                                            Defect
                                        </th>
                                        <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 align-middle text-center">
                                            OC SN
                                        </th>
        
                                        <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 align-middle text-center">
                                            Picture of Defect
                                        </th>
        
                                        <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 align-middle text-center">
                                            Picture of Panel SN
                                        </th>
        
                                        <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 align-middle text-center">
                                            Picture of OC SN
                                        </th>
        
                                        <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 align-middle text-center">
                                            Lot Number
                                        </th>
        
                                        <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 align-middle text-center">
                                            Scrap File
                                        </th>
        
                                        <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 align-middle text-center">
                                            Remark
                                        </th>

                                        <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 align-middle text-center">
                                            Reason of Refuse
                                        </th>
                                        <% if(user.role === "admin" || user.role === "agent") {%>
                                            <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder align-middle text-center opacity-7">
                                                Operation
                                            </th>
                                        <% } %>
                                    </tr>
                                </thead>
                                <tbody id="no-valid-table-body" hx-target="closest tr" hx-swap="outerHTML">
                                
                                    <% rmas.filter(rma => rma.validation_state != 2).map(rma => { %>
                                        <tr class="py-2 <%=rma.validation_state == 1 ? 'bg_danger' : 'bg_warning'%>" >
                                            <td class="align-middle text-start text-sm custom-border-start text-sm border-start border-bottom-0 <%=rma.validation_state == 1 ? 'border-danger' : 'border-warning'%>">
                                                <span class="d-none"><%= rma.validation_state %></span> <!-- Hidden value for filtering -->
                                                <% if(rma.validation_state == 1) { %>
                                                    <span class="badge bg-danger text-white">Refused</span>
                                                <% } else if(rma.validation_state == 0) { %>
                                                    <span class="badge bg-warning text-white">Pending</span>
                                                <% } %>
                                            </td>
                                            
                                            <td class="align-middle text-center text-sm text-sm ">
                                                <h5 class="mb-0 text-sm text-uppercase text-secondary">
                                                    <%= rma.country_name %>
                                                </h5>
                                            </td>
                                            <td class="align-middle text-center text-sm">
                                                <h5 class="mb-0 text-sm text-uppercase text-secondary">
                                                    <%= rma.customer_name %>
                                                </h5>
                                            </td>
                                            <td class="align-middle text-center text-sm">
                                                <%= rma.datecreated %>
                                            </td>
                                            <td class="align-middle text-center text-sm">
                                                <h5 class="mb-0 text-sm text-uppercase">
                                                    <%= rma.process_name %>
                                                </h5>
                                            </td>
                                            <td class="align-middle text-center text-sm">
                                                <h5 class="mb-0 text-sm text-secondary">
                                                    <%= rma.brand_name %>
                                                </h5>
                                            </td>
        
                                            <td class="align-middle text-center text-sm">
                                                <h5 class="mb-0 text-sm">
                                                    <%= rma.supplier_name %>
                                                </h5>
                                            </td>
        
                                            <td class="align-middle text-center text-sm">
                                                <h5 class="mb-0 text-sm text-secondary">
                                                    <%= rma.product_name %>
                                                </h5>
                                            </td>
        
                                            <td class="align-middle text-center text-sm">
                                                <%= rma.size %>
                                            </td>
        
                                            <td class="align-middle text-center text-sm">
                                                <%= rma.odf %>
                                            </td>
                                            <td class="align-middle text-center text-sm">
                                                <%= rma.oc_ref %>
                                            </td>
        
                                            <td class="align-middle text-center text-sm">
                                                <%= rma.defect_name %>
                                            </td>
        
                                            <td class="align-middle text-center text-sm">
                                                <%= rma.oc_sn %>
                                            </td>
        
                                            <td class="align-middle text-center text-sm">
                                                <img height="50" src="/uploads/<%= rma.picture_of_defect %>"  " alt="picture of defect">
                                            </td>
        
                                            <td class="align-middle text-center text-sm">
                                                <% if(rma.picture_of_panel_sn) { %>
                                                    <img height="50" src="/uploads/<%= rma.picture_of_panel_sn %>"  " alt="picture of panel sn">
                                                <% } else { %>
                                                    /
                                                <% } %>
                                            </td>
        
                                            <td class="align-middle text-center text-sm ">
                                                <img height="50" src="/uploads/<%= rma.oc_sn_picture %>"  " alt="picture of oc sn">
                                            </td>
        
                                            <td class="align-middle text-center text-sm">
                                                <%= rma.lot_number %>
                                            </td>
        
                                            <td class="align-middle text-center text-sm">
                                                <% if (rma.scrap_file) { %>
                                                    <a href="/uploads/<%= rma.scrap_file %>" target="_blank"><%= rma.scrap_file %></a>
                                                <% } else { %>
                                                    /
                                                <% } %>
                                            </td>
        
                                            <td class="align-middle text-center text-sm">
                                                <h5 class="mb-0 text-sm text-uppercase">
                                                    <%= rma.remark %>
                                                </h5>
                                            </td>

                                            <td class="align-middle text-center text-sm">
                                                <h5 class="mb-0 text-sm text-danger text-uppercase">
                                                    <%= rma.refused_reason %>
                                                </h5>
                                            </td>

                                            
                                                <td class="align-end  text-end text-end">
                                                    <div class="row flex-nowrap">
                                                        <% if(user.role === "admin") {%>
                                                            <!-- validation -->
                                                            <div class="col align-middle ">
                                                                <a class="validate_btn" data-id="<%= rma.id %>"  data-bs-target="#ValidationModal" title="validate" href="" data-bs-toggle="modal" data-container="body" data-animation="true" class="pe-2 btn-tooltip" data-bs-toggle="tooltip" data-bs-placement="top"
                                                                    data-container="body" data-animation="true">
                                                                    <i class="fas fa-check text-success"></i>           
                                                                </a>
                                                            </div>

                                                            <!-- refuse -->
                                                            <div class="col align-middle ">
                                                                <a class="refuse_btn" data-id="<%= rma.id %>"  data-bs-target="#RefuseModal" title="validate" href="" data-bs-toggle="modal" data-container="body" data-animation="true" class="pe-2 btn-tooltip" data-bs-toggle="tooltip" data-bs-placement="top"
                                                                    data-container="body" data-animation="true">
                                                                    <img src="https://img.icons8.com/ios-glyphs/25/b60707/multiply.png" alt="multiply"/>            
                                                                </a>
                                                            </div>
                                                        <% } %>

                                                        <% if(user.role === "admin" || (user.role === "agent" && rma.validation_state !== 2) ) {%>
                                                            <!-- edit -->
                                                            <div class="col align-middle ">
                                                                <a  href="javascript:;"  data-bs-toggle="modal" 
                                                                    data-bs-target="#dialog"  data-original-title="Edit"
                                                                    class="text_main_color font-weight-bold text-sm" 
                                                                    hx-get="/api/rma/edit"
                                                                    hx-vals="js:{'id':'<%=rma.id%>'}"
                                                                    hx-target="#dialog-body"
                                                                    hx-swap="innerHTML"
                                                                    hx-indicator=".loading-spinner">
                                                                    <i class="fas fa-pencil-alt "></i>
                                                                    <!-- Edit -->
                                                                </a>
                                                            </div>
                                                            
                                                            <!-- delete -->
                                                            <div class=" col align-middle ">
                                                                <a  href="javascript:;" class="text-red font-weight-bold text-sm"
                                                                    data-bs-toggle="modal" 
                                                                    data-bs-target="#dialog"  data-original-title="Edit"
                                                                    hx-get="/api/rma/delete" 
                                                                    hx-vals="js:{'id':'<%= rma.id %>'}"
                                                                    hx-target="#dialog-body"
                                                                    hx-swap="innerHTML"
                                                                    hx-indicator=".loading-spinner">
                                                                    <i class="fas fa-trash text-danger"></i>
                                                                    <!-- Delete -->
                                                                </a>
                                                            </div>
                                                        <% } %>

                                                        <% if(user.role === "admin" || user.role === "agent") {%>
                                                            <!-- scrap FILE -->
                                                            <div class=" col align-middle">
                                                                <a  href="javascript:;" class="text-info font-weight-bold text-sm"
                                                                    data-bs-toggle="modal" 
                                                                    data-bs-target="#dialog"  data-original-title="SCRAP FILE"
                                                                    hx-get="/api/rma/scrap_file" 
                                                                    hx-vals="js:{'id':'<%= rma.id %>'}"
                                                                    hx-target="#dialog-body"
                                                                    hx-swap="innerHTML"
                                                                    hx-indicator=".loading-spinner">
                                                                    <i class="fas fa-file"></i>
                                                                    <!-- Delete -->
                                                                </a>
                                                            </div>
                                                        <% } %>
                                                    </div>
                                                </td>
                                            
                                        </tr>
                                    <% }) %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div> 
            </div>
        <% } %>

    </div>



    <!-- Modal -->
    <div class="modal fade" data-bs-backdrop="static" id="dialog" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
            <div class="modal-content">
                
                <div class="modal-header d-flex align-items-center flex-column  border-0 ">
                    <button type="button" class="btn-close text-black text-xxl" data-bs-dismiss="modal" aria-label="Close">&times;</button>
                    <img src="https://img.icons8.com/fluency-systems-regular/100/return-merchandise-authorization.png" alt="return-merchandise-authorization"/>
                    <h4 class="nav-link-text font-weight-bold modal-title text-black text-uppercase " id="modal-title"></h4>
                    
                </div>

                <div id="error_message" class="alert bg-danger mx-3 font-weight-bold text-white alert-dismissible fade show error_message" role="alert" style="display: none;">
                    
                </div>
               
                <!-- Loading spinner -->
                <div id="loading-spinner" class="loading-spinner text-center py-3" style="display: none;">
                    <div class="spinner-border text-dark" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    <p>Loading...</p>
                </div>

                <div class="modal-body" id="dialog-body" >
                   
                 </div>
                 
            </div>
            
        </div>
    </div>

    <!-- validate -->
    <div class="modal fade" data-bs-backdrop="static"  id="ValidationModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <form hx-patch="/api/rma/validation_state" hx-target="this" hx-swap="none">
                    <div class="modal-header d-flex align-items-center flex-column my-4  border-0" id="modal-header" style="display: contents;">
                        <img src="https://img.icons8.com/pulsar-color/90/instagram-check-mark.png" alt="instagram-check-mark"/>                   
                        <h5 class="nav-link-text font-weight-bold modal-title text-dark text-uppercase">Are you Sure you want to validate this RMA Request ?</h5>
                        <input type="hidden" name="rma_id" class="rma_id" value="">
                        <input type="hidden" id="rma_state" name="rma_state" value="2">
                    </div>
                    <div class="modal-footer p-0 px-2">
                        <button type="button" class="btn bg-secondary text-white" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn bg_color text-white" data-bs-dismiss="modal">Approve</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- Refuse -->
    <div class="modal fade" data-bs-backdrop="static" id="RefuseModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <form hx-patch="/api/rma/validation_state" hx-target="this" hx-swap="none">
                    <div class="modal-header d-flex align-items-center flex-column my-4  border-0" id="modal-header" style="display: contents;">
                        <img src="https://img.icons8.com/pulsar-gradient/90/cancel-2.png" alt="cancel-2"/>
                        <h5 class="nav-link-text font-weight-bold modal-title text-dark text-uppercase">Are you sure you want to refuse this RMA Request?</h5>
                        <div class="form-group d-block justify-content-start">
                            <label for="reason" class="h5">Please enter the reason</label>
                            <textarea class="form-control form-control-xl" name="reason" id="reason" value="" rows="3"></textarea>
                        </div>
                        <input type="hidden" id="rma_state" name="rma_state" value="1">
                        <input type="hidden" name="rma_id" class="rma_id" value="">
                    </div>
                    <div class="modal-footer p-0 px-2">
                        <button type="button" class="btn bg-secondary text-white" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn bg-danger text-white" data-bs-dismiss="modal">Refuse</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    

    <%- include('../toasts/success-toast'); %>
    <%- include('../toasts/danger-toast'); %>
    <%- include('../partials/footer'); %>
    <%- include('../partials/columnFilter'); %>
    <%- include('../partials/columnFilterRMA'); %>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js" integrity="sha512-dlPw+ytv/6JyepmelABrgeYgHI0O+frEwgfnPdXDTOIZz+eDgfW07QXG02/O8COfivBdGNINy+Vex+lYmJ5rxw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        $(document).ready(function() {
            initializeDataTable("rma-table");
            initializeDataTableRMA("no-valid-rma-table")
            setTimeout(()=>{
                
                $('#success-toast').addClass("d-none");

            }, 3000)
        });

        htmx.on('htmx:responseError', (e) => {
            const url = e.detail.xhr.responseURL;
            const status = e.detail.xhr.status;

            if (url.includes("/api/rma/export")) {
                console.log("error => ", e.detail.xhr.responseText);
                if (status === 400) {
                    let message = e.detail.xhr.responseText;
                    // Delete form error handling
                    $(".toast-danger-body").text(message);
                    $(".toast-danger").show();
                    
                    setTimeout(() => {
                        $(".toast-danger-body").text("");
                        $(".toast-danger").hide();
                    }, 5000);
                }
            }

            if (url.includes("/api/rma/validation_state")) {
                
                if (status === 400) {
                    let message = e.detail.xhr.responseText;
                    // Delete form error handling
                    $(".toast-danger-body").text(message);
                    $(".toast-danger").show();
                    
                    setTimeout(() => {
                        $(".toast-danger-body").text("");
                        $(".toast-danger").hide();
                    }, 5000);
                }
            }
        });


        htmx.on('htmx:afterRequest', (e) => {

            if(e.detail.xhr.responseURL.includes("/api/rma/export") && e.detail.xhr.status === 200) {
                $("#error-message").addClass("d-none");
                $("#error-message").html("");

                $("#dialog").modal('hide');
                $(".toast-success-body").text("RMA downloaded successfully");
                $(".toast-success").show();
                
                setTimeout(() => {
                    $(".toast-success-body").text("");
                    $(".toast-success").hide();
                    location.reload();
                }, 1000);

            }

            if(e.detail.xhr.responseURL.includes("/api/rma/validation_state") && e.detail.xhr.status === 204) {
                $("#error-message").addClass("d-none");
                $("#error-message").html("");

                $("#dialog").modal('hide');
                $(".toast-success-body").text("State changed successfully");
                $(".toast-success").show();
                
                setTimeout(() => {
                    $(".toast-success-body").text("");
                    $(".toast-success").hide();
                    location.reload();
                }, 1000);

            }

            });

            
    </script>


<script>
   
    $(document).ready(function () {
        $(document).on('click', '.validate_btn', function () {
            let id = $(this).data("id");
            $(".rma_id").val(id);
        });

        // Use event delegation for .refuse_btn
        $(document).on('click', '.refuse_btn', function () {
            let id = $(this).data("id");
            $(".rma_id").val(id);
        });

        $('#exportBtn').on('click', function () {

            // get dates from input fields
            var startDate = $('#date_debut').val();
            var endDate = $('#date_fin').val();


            // Send the selected RMAs to the server via AJAX
            $.ajax({
                url: '/api/rma/export', // Your export route
                method: 'POST',
                data: {
                    startDate: startDate,
                    endDate: endDate
                },
                xhrFields: {
                    responseType: 'blob' // Important to handle the file download
                },
                success: function (response) {
                    // Create a link element for downloading the file
                    var link = document.createElement('a');
                    link.href = window.URL.createObjectURL(response);
                    link.download = `rma_export_${new Date().toISOString().split('T')[0]}.xlsx`; // Set default file name
                    link.click(); // Trigger the download
                },
                error: function (error) {
                    let error_message = "Failed to export RMAs. Please try again."
                    console.log("error => ", error, " status : ", error.status);
                    if(error.status === 404)
                        error_message = "No RMA Requests were found for the selected dates"
                    $(".toast-danger-body").text(error_message);
                $(".toast-danger").show();
                
                setTimeout(() => {
                    $(".toast-danger-body").text("");
                    $(".toast-danger").hide();
                }, 3000);
                }
            });
        });
    });
</script>

<script>
    $(document).on('click', '.btn-close', function () {
            $(".modal-title").text("");
    });
    htmx.on('htmx:beforeRequest',  (e) => {
        const url = e.detail.elt.getAttribute('hx-get');  
        if(url.includes("/create") || url.includes("/delete") || url.includes("/edit")){
            document.querySelector('.loading-spinner').style.display = 'block'; 
            document.getElementById('error_message').style.display = 'none';    
            document.getElementById('dialog-body').innerHTML = '';              
        }
    });

    // Event listener for when the request completes (hide the spinner)
    htmx.on('htmx:afterRequest', function (e) {
        const url = e.detail.elt.getAttribute('hx-get');  

        if(url.includes("/create") || url.includes("/delete") || url.includes("/edit"))
            document.querySelector('.loading-spinner').style.display = 'none'; 
    
    });

    // Event listener for handling request errors
    htmx.on('htmx:responseError', function (e) {
        const url = e.detail.elt.getAttribute('hx-get');  

        if(url.includes("/create") || url.includes("/delete") || url.includes("/edit")){
            document.querySelector('.loading-spinner').style.display = 'none';
            document.getElementById('error_message').style.display = 'block';
        }
    });
</script>